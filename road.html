<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>道路資訊查詢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        input, button, select {
            padding: 10px;
            margin: 5px;
            font-size: 16px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        .road-width {
            color: red;
            font-weight: bold;
        }
        #status {
            margin: 10px;
            font-size: 14px;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <h1>道路資訊查詢</h1>
        <p>請輸入路名的關鍵字進行查詢：</p>
        <input type="text" id="roadName" placeholder="輸入路名關鍵字">
        <button onclick="queryRoadData()">搜尋</button>
        <div id="status"></div>
       
<input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleFileUpload(event)">

        <div id="filters" style="display: none;">
            <select id="areaFilter" onchange="applyFilters()">
                <option value="">所有地區</option>
            </select>
            <select id="laneFilter" onchange="applyFilters()">
                <option value="">所有巷</option>
            </select>
            <select id="alleyFilter" onchange="applyFilters()">
                <option value="">所有弄</option>
            </select>
        </div>
        <div id="result"></div>
    </div>

    <h6>2025/09/10修正</h6>

  <script>
  let csvData = [];
  let filteredData = [];

  function stripBOM(s = "") {
    return s.replace(/^\uFEFF/, "");
  }

  // 更穩健的 CSV 解析：處理 \r\n、空行、BOM；（簡化版，未完整支援引號+逗號）
  function parseCSV(text) {
    const cleaned = stripBOM(text || "");
    const lines = cleaned.split(/\r?\n/).filter(l => l.trim() !== "");
    if (lines.length === 0) return [];

    const headers = lines.shift().split(",").map(h => stripBOM(h).trim());

    return lines.map(line => {
      const cols = line.split(","); // 若未使用含逗號的引號欄位，這樣就夠
      const obj = {};
      headers.forEach((header, i) => {
        const v = (cols[i] ?? "").trim();
        obj[header] = v || "無資料";
      });
      return obj;
    });
  }

  async function loadCSV() {
    const statusDiv = document.getElementById('status');
    const fileInput = document.getElementById('csvFile');

    // 若以 file:// 直接開啟，很多瀏覽器會封鎖 fetch 本機檔案
    const isFileProtocol = location.protocol === 'file:';
    if (isFileProtocol) {
      statusDiv.innerHTML = `
        <p class="error">偵測到以 <code>file://</code> 開啟，瀏覽器可能封鎖讀取 <code>road.csv</code>。</p>
        <p>請點選下方按鈕改用手動載入檔案，或以本機伺服器開啟（例如 VSCode Live Server / <code>npx serve</code>）。</p>
      `;
      fileInput.style.display = 'inline-block';
      return;
    }

    const filePath = './road.csv';
    try {
      const response = await fetch(filePath, { cache: 'no-store' });
      if (!response.ok) throw new Error(`HTTP ${response.status} ${response.statusText}`);

      const text = await response.text();
      const parsed = parseCSV(text);

      if (!parsed.length) throw new Error('CSV 內容為空或標題列不合法');

      csvData = parsed;
      statusDiv.innerHTML = '<p class="success">成功讀取 road.csv 檔案！</p>';
      console.log("CSV 檔案已成功載入！筆數：", csvData.length);
    } catch (error) {
      statusDiv.innerHTML = `
        <p class="error">讀取 <code>road.csv</code> 失敗：${error.message}</p>
        <p>請改用下方「選擇檔案」載入，或以本機伺服器方式開啟此頁。</p>
      `;
      console.error("載入 CSV 檔案失敗:", error);
      // 顯示備援的檔案上傳
      fileInput.style.display = 'inline-block';
    }
  }

  // 備援：使用者手動選擇 CSV
  function handleFileUpload(evt) {
    const statusDiv = document.getElementById('status');
    const file = evt.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const parsed = parseCSV(text);
        if (!parsed.length) throw new Error('CSV 內容為空或標題列不合法');
        csvData = parsed;
        statusDiv.innerHTML = '<p class="success">已從檔案成功載入 CSV！</p>';
      } catch (err) {
        statusDiv.innerHTML = `<p class="error">解析 CSV 失敗：${err.message}</p>`;
      }
    };
    reader.onerror = () => {
      statusDiv.innerHTML = `<p class="error">無法讀取所選檔案。</p>`;
    };
    reader.readAsText(file, 'utf-8');
  }

  function queryRoadData() {
    const roadName = document.getElementById('roadName').value.trim();
    const resultDiv = document.getElementById('result');
    const filtersDiv = document.getElementById('filters');

    if (!csvData.length) {
      resultDiv.innerHTML = '<p style="color:red;">尚未載入 CSV（請確認已讀取成功或選擇檔案）</p>';
      filtersDiv.style.display = 'none';
      return;
    }

    if (!roadName) {
      resultDiv.innerHTML = '<p style="color:red;">請輸入路名的關鍵字！</p>';
      filtersDiv.style.display = 'none';
      return;
    }

    filteredData = csvData.filter(row => (row['路名'] || '').includes(roadName));
    if (filteredData.length === 0) {
      resultDiv.innerHTML = `<p>沒有找到包含「${roadName}」的道路資料。</p>`;
      filtersDiv.style.display = 'none';
      return;
    }

    populateFilters();
    filtersDiv.style.display = 'block';
    displayResults(filteredData);
  }

  function populateFilters() {
    const areaSet = new Set(filteredData.map(row => row['地區'] || ''));
    const laneSet = new Set(filteredData.map(row => row['巷'] || ''));
    const alleySet = new Set(filteredData.map(row => row['弄'] || ''));

    const areaFilter = document.getElementById('areaFilter');
    const laneFilter = document.getElementById('laneFilter');
    const alleyFilter = document.getElementById('alleyFilter');

    areaFilter.innerHTML = '<option value="">所有地區</option>';
    laneFilter.innerHTML = '<option value="">所有巷</option>';
    alleyFilter.innerHTML = '<option value="">所有弄</option>';

    for (const v of areaSet) if (v) areaFilter.appendChild(new Option(v, v));
    for (const v of laneSet) if (v) laneFilter.appendChild(new Option(v, v));
    for (const v of alleySet) if (v) alleyFilter.appendChild(new Option(v, v));
  }

  function applyFilters() {
    const area = document.getElementById('areaFilter').value;
    const lane = document.getElementById('laneFilter').value;
    const alley = document.getElementById('alleyFilter').value;

    const results = filteredData.filter(row => {
      const areaMatch = !area || row['地區'] === area;
      const laneMatch = !lane || row['巷'] === lane;
      const alleyMatch = !alley || row['弄'] === alley;
      return areaMatch && laneMatch && alleyMatch;
    });

    displayResults(results);
  }

  function displayResults(results) {
    const resultDiv = document.getElementById('result');
    if (!results.length) {
      resultDiv.innerHTML = `<p>沒有符合篩選條件的資料。</p>`;
      return;
    }

    let html = `
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>路名</th>
            <th>地區</th>
            <th>巷</th>
            <th>弄</th>
            <th>路寬</th>
          </tr>
        </thead>
        <tbody>
    `;

    results.forEach((item, idx) => {
      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${item['路名'] || '無資料'}</td>
          <td>${item['地區'] || '無資料'}</td>
          <td>${item['巷'] || '無資料'}</td>
          <td>${item['弄'] || '無資料'}</td>
          <td class="road-width">${item['路寬'] || '無資料'}</td>
        </tr>`;
    });

    html += `</tbody></table>`;
    resultDiv.innerHTML = html;
  }

  window.onload = loadCSV;
</script>

</body>
</html>

